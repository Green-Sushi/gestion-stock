<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#088F8F">
    <title>Gestion de Stock - Green Sushi</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="icon.png" type="image/png">
    <link rel="apple-touch-icon" href="icon-192.png">
    <style>
        /* --- STYLES GLOBAUX --- */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: #333;
        }
        
        /* --- HEADER --- */
        header {
            background-color: #088F8F;
            color: white;
        
            left: 0;
            right: 0;
            z-index: 100;
            height: 60px;
        }
        
        header h1 {
            font-size: 1.2rem;
            text-align: center;
            margin-bottom: 5px;
        }
        
        .alert-badge {
            background-color: #e74c3c;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            position: absolute;
            top: 10px;
            right: 10px;
        }
        
        /* --- CONTENEUR PRINCIPAL --- */
        .container {
            margin-top: 80px;
            margin-bottom: 80px;
            padding: 15px;
        }
        
        /* --- PAGES --- */
        .page {
            display: none;
        }
        
        .page.active {     }
        
        .tab {
            padding: 10px;
            text-align: center;
            flex: 1;
            cursor: pointer;
        }
        
        .tab.active {
            color: #088F8F;
            border-top: 2px solid #088F8F;
        }
        
        /* --- CARTES CATÉGORIES --- */
        .categories-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        
        .category-card {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .category-card:hover {
            transform: translateY(-5px);
        }
        
        .category-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }
        
        /* --- PRODUCTS HEADER --- */
        .products-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            margin-top: 10px;
            padding-top: 5px;
        }
        
        .back-button {
            background: none;
            border: none;
            color: #088F8F;
            cursor: pointer;
            font-size: 1.2rem;
        }
        
        .product-item {
            background-color: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .product-info {
            flex: 1;
        }
        
        .product-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .product-supplier {
            font-size: 0.8rem;
            color: #777;
        }
        
        .product-controls {
            display: flex;
            align-items: center;
            margin: 0 10px;
        }
        
        .product-quantity {
            margin-right: 5px;
            min-width: 70px;
            text-align: right;
        }
        
        .product-quantity.low-stock {
            color: #e74c3c;
            font-weight: bold;
        }
        
        .quantity-controls {
            display: flex;
            flex-direction: column;
      
            font-weight: bold;
        }
        
        .reorder-buttons {
            display: flex;
            flex-direction: column;
            margin-right: 5px;
        }
        
        .reorder-button {
            background: none;
            border: none;
            font-size: 0.8rem;
            padding: 0;
            margin: 0;
            cursor: pointer;
            color: #777;
            height: 12px;
            line-height: 1;
        }
        
        .reorder-button:hover {
            color: #088F8F;
        }
        
        /* Animation pour l'ajout à la commande */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }
        
        .pulse {
            animation: pulse 0.5s;
        }
        
        /* --- FORMULAIRE D'AJOUT/ÉDITION --- */
        .form-container {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .form-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        
        .form-buttons button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .cancel-button {
            background-color: #ddd;
        }
        
        .submit-button {
            background-color: #088F8F;
            color: white;
        }
        
        /* --- GROUPES DE CATÉGORIES --- */
        .category-group {
            margin-bottom: 15px;
        }
        
        .category-header {
            background-color: #f9f9f9;
            padding: 10px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            margin-bottom: 5px;
        }
        
        .category-content {
            margin-left: 20px;
        }
        
        /* --- MODAL --- */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            width: 80%;
            max-width: 400px;
        }
        
        .modal-title {
            font-size: 1.2rem;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .modal-buttons {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
        }
        
        .modal-buttons button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        /* --- POPUP --- */
        .popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(8, 143, 143, 0.9);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 1002;
            display: none;
            text-align: center;
            font-weight: bold;
        }
        
        @keyframes fadeInOut {
            0% { opacity: 0; }
            20% { opacity: 1; }
            80% { opacity: 1; }
            100% { opacity: 0; }
        }
        
        .popup-animation {
            display: block;
            animation: fadeInOut 1.5s forwards;
        }
        
        /* --- EMAIL FORM --- */
        .email-form {
            margin-top: 20px;
        }
        
        .email-form input {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .email-submit {
            background-color: #088F8F;
            color: white;
            padding: 10px;
            border: none;
            border-radius: 5px;
            width: 100%;
            cursor: pointer;
        }
        
        /* --- EMPTY STATE --- */
        .empty-state {
            text-align: center;
            padding: 30px;
            color: #777;
        }
        
        .add-button {
            background-color: #088F8F;
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: fixed;
            bottom: 80px;
            right: 20px;
            font-size: 1.5rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            cursor: pointer;
            border: none;
            z-index: 99;
        }
        
        /* --- NOTIFICATION --- */
        .notification {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #088F8F;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            display: none;
            z-index: 1001;
        }
        
        /* --- STATS PAGE --- */
        .stats-container {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .stats-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .stats-card {
            background-color: #f9f9f9;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .stats-value {
            font-size: 2rem;
            font-weight: bold;
            color: #088F8F;
            margin: 10px 0;
        }
        
        .stats-title {
            font-size: 1rem;
            color: #777;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        .stats-info {
            font-size: 0.85rem;
            color: #777;
            font-style: italic;
            margin-top: 10px;
            text-align: center;
        }
        
        .supplier-select-container {
            display: flex;
            gap: 10px;
        }
        
        .supplier-select-container select {
            flex: 1;
        }
        
        .small-button {
            background-color: #088F8F;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .supplier-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #f9f9f9;
            padding: 10px;
            margin-bottom: 5px;
            border-radius: 5px;
        }
        
        .supplier-actions {
            display: flex;
            gap: 5px;
        }
        
        .supplier-delete {
            color: #e74c3c;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
        }
        
        .supplier-input-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .supplier-input-container input {
            flex: 1;
            padding: 8px;
        }
        
        #suppliers-list {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 15px;
        }
        
        /* --- HISTORY PAGE --- */
        .history-filters {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            background-color: #f9f9f9;
            border-radius: 10px;
            padding: 10px;
        }
        
        .history-filter {
            flex: 1;
            text-align: center;
            padding: 5px;
            cursor: pointer;
            border-radius: 5px;
        }
        
        .history-filter.active {
            background-color: #088F8F;
            color: white;
        }
        
        .history-item {
            background-color: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .history-date {
            font-size: 0.8rem;
            color: #777;
            margin-bottom: 5px;
        }
        
        .history-action {
            font-weight: bold;
            color: #088F8F;
        }
        
        .history-details {
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <!-- HEADER -->
    <header>
        <h1>Gestion de Stock - Green Sushi</h1>
        <div class="alert-badge" id="alert-count">0</div>
    </header>
    
    <!-- CONTENEUR PRINCIPAL -->
    <div class="container">
        <!-- PAGE D'ACCUEIL -->
        <div id="home-page" class="page active">
            <div class="categories-grid" id="categories-container">
                <div class="category-card" data-category="sec">
                    <div class="category-icon">🌾</div>
                    <div>Stock Sec</div>
                </div>
                <div class="category-card" data-category="frais">
                    <div class="category-icon">🧀</div>
                    <div>Stock Frais</div>
                </div>
                <div class="category-card" data-category="surgele">
                    <div class="category-icon">❄️</div>
                    <div>Stock Surgelé</div>
                </div>
                <div class="category-card" data-category="boissons">
                    <div class="category-icon">🧃</div>
                    <div>Stock Boissons</div>
                </div>
                <div class="category-card" data-category="consommable">
                    <div class="category-icon">🥢</div>
                    <div>Stock Consommable</div>
                </div>
                <div class="category-card" data-category="commandes">
                    <div class="category-icon">📋</div>
                    <div>Liste Commandes</div>
                </div>
            </div>
        </div>
        
        <!-- PAGE DE PRODUITS -->
        <div id="products-page" class="page">
            <div class="products-header">
                <button id="back-to-home" class="back-button">←</button>
                <h2 id="category-title">Stock Sec</h2>
                <div style="width: 20px;"></div>
            </div>
            <div id="products-list"></div>
            <button id="add-product" class="add-button">+</button>
        </div>
        
        <!-- PAGE D'AJOUT/ÉDITION DE PRODUIT -->
        <div id="add-product-page" class="page">
            <div class="products-header">
                <button id="back-to-products" class="back-button">←</button>
                <h2 id="form-title">Ajouter Produit</h2>
                <div style="width: 20px;"></div>
            </div>
            <div class="form-container">
                <form id="product-form">
                    <div class="form-group">
                        <label for="product-name">Nom du produit</label>
                        <input type="text" id="product-name" required>
                    </div>
                    <div class="form-group">
                        <label for="product-quantity">Quantité</label>
                        <input type="number" id="product-quantity" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="product-unit">Unité</label>
                        <input type="text" id="product-unit" required>
                    </div>
                    <div class="form-group">
                        <label for="product-alert">Alerte quantité basse</label>
                        <input type="number" id="product-alert" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="product-price">Prix (€)</label>
                        <input type="number" id="product-price" min="0" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="product-supplier">Fournisseur</label>
                        <div class="supplier-select-container">
                            <select id="product-supplier" required>
                                <!-- Options générées par JavaScript -->
                            </select>
                            <button type="button" id="manage-suppliers" class="small-button">Gérer</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- PAGE D'ALERTES -->
        <div id="alerts-page" class="page">
            <h2>Alertes Stock Bas</h2>
            <div id="alerts-list"></div>
        </div>
        
        <!-- PAGE DE COMMANDES -->
        <div id="orders-page" class="page">
            <h2>Liste de Commandes</h2>
            <div id="orders-list"></div>
            <div class="email-form">
                <h3>Exporter les commandes</h3>
                <input type="email" id="email-to" placeholder="Email du destinataire" required>
                <input type="text" id="email-subject" placeholder="Sujet de l'email" value="Commandes Green Sushi" required>
                <button id="export-orders" class="email-submit">Envoyer par Email</button>
            </div>
        </div>
        
        <!-- PAGE DE STATISTIQUES -->
        <div id="stats-page" class="page">
            <h2>Statistiques</h2>
            <div class="stats-container">
                <div class="stats-grid">
                    <div class="stats-card">
                        <div class="stats-title">Total Produits</div>
                        <div class="stats-value" id="stats-total-products">0</div>
                    </div>
                    <div class="stats-card">
                        <div class="stats-title">Produits en Alerte</div>
                        <div class="stats-value" id="stats-low-stock">0</div>
                    </div>
                    <div class="stats-card">
                        <div class="stats-title">Commandes en cours</div>
                        <div class="stats-value" id="stats-orders">0</div>
                    </div>
                    <div class="stats-card">
                        <div class="stats-title">Valeur Estimée</div>
                        <div class="stats-value" id="stats-value">0 €</div>
                        <div class="stats-info" id="stats-value-info">
                            Valeur estimée basée sur la quantité moyenne des produits
                        </div>
                    </div>
                </div>
            </div>
            
            <h3>Historique des Mouvements</h3>
            <div class="history-filters">
                <div class="history-filter active" data-period="week">1 Semaine</div>
                <div class="history-filter" data-period="month">1 Mois</div>
                <div class="history-filter" data-period="quarter">3 Mois</div>
            </div>
            <div id="history-list"></div>
            <button id="reset-history" class="reset-button">Réinitialiser l'historique</button>
        </div>
    </div>
    
    <!-- NAVIGATION -->
    <nav>
        <div class="tab active" data-page="home-page">🏠<br>Accueil</div>
        <div class="tab" data-page="alerts-page">🔔<br>Alertes</div>
        <div class="tab" data-page="orders-page">📋<br>Commandes</div>
        <div class="tab" data-page="stats-page">📊<br>Stats</div>
    </nav>
    
    <!-- POPUP -->
    <div id="popup" class="popup"></div>
    
    <!-- NOTIFICATION -->
    <div id="inventory-notification" class="notification">Stock mis à jour avec succès!</div>
    
    <!-- MODAL DE GESTION DES FOURNISSEURS -->
    <div id="suppliers-modal" class="modal">
        <div class="modal-content">
            <div class="modal-title">Gestion des Fournisseurs</div>
            <div id="suppliers-list"></div>
            <div class="supplier-form">
                <div class="form-group">
                    <label for="supplier-name">Nom du fournisseur</label>
                    <div class="supplier-input-container">
                        <input type="text" id="supplier-name" placeholder="Ajouter un fournisseur">
                        <button id="add-supplier" class="small-button">+</button>
                    </div>
                </div>
            </div>
            <div class="modal-buttons">
                <button id="close-suppliers-modal" class="submit-button">Fermer</button>
            </div>
        </div>
    </div>
    
    <script>
        // Enregistrement du service worker pour la PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(reg => console.log('Service Worker enregistré'))
                    .catch(err => console.error('Erreur lors de l\'enregistrement du Service Worker:', err));
            });
        }
        
        // ------------------------------
        // MODÈLE DE DONNÉES CENTRALISÉ
        // ------------------------------
        const StockData = {
            // Liste des fournisseurs disponibles
            suppliers: [
                "Métro",
                "Promocash",
                "Fromager Local",
                "Poissonnerie Maritime",
                "Caviste",
                "Distriboissons",
                "Fournitures Pro",
                "Distributeur Asiatique",
                "Grossiste Bio"
            ],
            
            categories: {
                'Stock Frais': [
                    {name: "Oeufs", quantity: 2, unit: "boîte de 6", supplier: "Métro", alert: 1, lowStock: false, price: 3.5},
                    {name: "Moutarde", quantity: 2, unit: "pot", supplier: "Promocash", alert: 1, lowStock: false, price: 2.8},
                    {name: "Tomate séchée", quantity: 2, unit: "pot", supplier: "Métro", alert: 1, lowStock: false, price: 4.2},
                    {name: "Piment d'Espelette", quantity: 2, unit: "pot", supplier: "Grossiste Bio", alert: 1, lowStock: false, price: 5.8},
                    {name: "Fromage carré crémeux", quantity: 15, unit: "boîtes", supplier: "Fromager Local", alert: 10, lowStock: false, price: 3.2},
                    {name: "Cheddar en tranche", quantity: 8, unit: "paquets", supplier: "Fromager Local", alert: 5, lowStock: false, price: 4.5},
                    {name: "Emmental en bloc", quantity: 2, unit: "bloc", supplier: "Fromager Local", alert: 1, lowStock: false, price: 12.5},
                    {name: "Concombre", quantity: 15, unit: "pièces", supplier: "Grossiste Bio", alert: 10, lowStock: false, price: 1.2},
                    {name: "Avocat", quantity: 7, unit: "pièces", supplier: "Grossiste Bio", alert: 5, lowStock: false, price: 2.5},
                    {name: "Oignon peyi", quantity: 1.5, unit: "kg", supplier: "Grossiste Bio", alert: 1, lowStock: false, price: 3.9},
                    {name: "Oignon rouge", quantity: 15, unit: "pièces", supplier: "Grossiste Bio", alert: 10, lowStock: false, price: 0.8},
                    {name: "Carottes", quantity: 4, unit: "pièces", supplier: "Grossiste Bio", alert: 2, lowStock: false, price: 0.6},
                    {name: "Chou rouge", quantity: 2, unit: "pièces", supplier: "Grossiste Bio", alert: 1, lowStock: false, price: 3.2},
                    {name: "Navet", quantity: 3, unit: "pièces", supplier: "Grossiste Bio", alert: 2, lowStock: false, price: 0.9}
                ],
                'Stock Surgelé': [
                    {name: "Boîte de crevettes tempura", quantity: 15, unit: "boîtes", supplier: "Poissonnerie Maritime", alert: 10, lowStock: false, price: 25.5},
                    {name: "Sachet de gyoza", quantity: 8, unit: "sachets", supplier: "Distributeur Asiatique", alert: 5, lowStock: false, price: 18.2},
                    {name: "Sachet de wakame", quantity: 7, unit: "sachets", supplier: "Distributeur Asiatique", alert: 5, lowStock: false, price: 12.5},
                    {name: "Carpaccio de boeuf", quantity: 2, unit: "sachet", supplier: "Promocash", alert: 1, lowStock: false, price: 22.9}
                ],
                'Stock Sec': [
                    {name: "Riz", quantity: 45, unit: "kg", supplier: "Distributeur Asiatique", alert: 40, lowStock: false, price: 3.8},
                    {name: "Sachet de panure Panko", quantity: 8, unit: "sachets", supplier: "Distributeur Asiatique", alert: 5, lowStock: false, price: 6.2},
                    {name: "Feuille d'algue nori", quantity: 7, unit: "sachets", supplier: "Distributeur Asiatique", alert: 5, lowStock: false, price: 15.8},
                    {name: "Sachet de gingembre mariné", quantity: 8, unit: "sachets", supplier: "Distributeur Asiatique", alert: 5, lowStock: false, price: 8.9},
                    {name: "Wasabi en poudre", quantity: 4, unit: "sachets", supplier: "Distributeur Asiatique", alert: 3, lowStock: false, price: 7.5},
                    {name: "Sauce soja Kikoman", quantity: 2, unit: "bidons de 20L", supplier: "Distributeur Asiatique", alert: 1, lowStock: false, price: 48.5},
                    {name: "Sauce Sweet", quantity: 2, unit: "bidon de 5L", supplier: "Distributeur Asiatique", alert: 1, lowStock: false, price: 22.9},
                    {name: "Sauce Sriracha", quantity: 2, unit: "bidon de 5L", supplier: "Distributeur Asiatique", alert: 1, lowStock: false, price: 19.8},
                    {name: "Vinaigre blanc", quantity: 2, unit: "bidons de 10L", supplier: "Métro", alert: 1, lowStock: false, price: 12.4},
                    {name: "Sucre blanc", quantity: 15, unit: "kg", supplier: "Métro", alert: 10, lowStock: false, price: 1.8},
                    {name: "Sucre roux", quantity: 15, unit: "kg", supplier: "Métro", alert: 10, lowStock: false, price: 2.2},
                    {name: "Huile de tournesol", quantity: 25, unit: "L", supplier: "Métro", alert: 20, lowStock: false, price: 3.5},
                    {name: "Farine", quantity: 8, unit: "kg", supplier: "Métro", alert: 5, lowStock: false, price: 1.6}
                ],
                'Stock Consommable': [
                    {name: "Baguettes chinoises", quantity: 15, unit: "sachets", supplier: "Distributeur Asiatique", alert: 10, lowStock: false, price: 5.9},
                    {name: "Film transparent", quantity: 2, unit: "rouleau", supplier: "Fournitures Pro", alert: 1, lowStock: false, price: 8.5},
                    {name: "Papier aluminium", quantity: 2, unit: "rouleau", supplier: "Fournitures Pro", alert: 1, lowStock: false, price: 7.8},
                    {name: "Sachet kraft grand format", quantity: 3, unit: "cartons", supplier: "Fournitures Pro", alert: 2, lowStock: false, price: 42.5},
                    {name: "Sachet kraft petit format", quantity: 3, unit: "cartons", supplier: "Fournitures Pro", alert: 2, lowStock: false, price: 35.9},
                    {name: "Plateaux ronds à sushi", quantity: 2, unit: "carton", supplier: "Distributeur Asiatique", alert: 1, lowStock: false, price: 65.2},
                    {name: "Produit pour le sol", quantity: 2, unit: "bidon", supplier: "Fournitures Pro", alert: 1, lowStock: false, price: 12.5},
                    {name: "Tête de serpillère", quantity: 3, unit: "exemplaires", supplier: "Fournitures Pro", alert: 2, lowStock: false, price: 6.8},
                    {name: "Produit lave-vaisselle", quantity: 2, unit: "sachet", supplier: "Fournitures Pro", alert: 1, lowStock: false, price: 15.9},
                    {name: "Boîte de gants (par taille)", quantity: 5, unit: "boîtes", supplier: "Fournitures Pro", alert: 3, lowStock: false, price: 9.5}
                ],
                'Stock Boissons': [
                    {name: "MR BASIL - Maracudja", quantity: 10, unit: "bouteilles", supplier: "Distriboissons", alert: 5, lowStock: false, price: 4.2},
                    {name: "MR BASIL - Mangue", quantity: 10, unit: "bouteilles", supplier: "Distriboissons", alert: 5, lowStock: false, price: 4.2},
                    {name: "MR BASIL - Grenade", quantity: 10, unit: "bouteilles", supplier: "Distriboissons", alert: 5, lowStock: false, price: 4.2},
                    {name: "MR BASIL - Kiwi", quantity: 10, unit: "bouteilles", supplier: "Distriboissons", alert: 5, lowStock: false, price: 4.2},
                    {name: "MR BASIL - Cocktails", quantity: 10, unit: "bouteilles", supplier: "Distriboissons", alert: 5, lowStock: false, price: 4.8},
                    {name: "KEFWI - Lanmou Red", quantity: 10, unit: "bouteilles", supplier: "Distriboissons", alert: 5, lowStock: false, price: 4.5},
                    {name: "KEFWI - Soley Cho", quantity: 10, unit: "bouteilles", supplier: "Distriboissons", alert: 5, lowStock: false, price: 4.5},
                    {name: "KEFWI - Power Flower", quantity: 10, unit: "bouteilles", supplier: "Distriboissons", alert: 5, lowStock: false, price: 4.5},
                    {name: "KEFWI - Fwisson", quantity: 10, unit: "bouteilles", supplier: "Distriboissons", alert: 5, lowStock: false, price: 4.5},
                    {name: "KEFWI - Ginger Beer", quantity: 10, unit: "bouteilles", supplier: "Distriboissons", alert: 5, lowStock: false, price: 4.5},
                    {name: "KEFWI - Golden Dousse", quantity: 10, unit: "bouteilles", supplier: "Distriboissons", alert: 5, lowStock: false, price: 4.5},
                    {name: "BIERES - Asahi", quantity: 24, unit: "bouteilles", supplier: "Caviste", alert: 12, lowStock: false, price: 3.9},
                    {name: "BIERES - Kirin", quantity: 24, unit: "bouteilles", supplier: "Caviste", alert: 12, lowStock: false, price: 3.9},
                    {name: "BIERES - Sapporo", quantity: 24, unit: "bouteilles", supplier: "Caviste", alert: 12, lowStock: false, price: 3.9},
                    {name: "BIERES - Chang", quantity: 24, unit: "bouteilles", supplier: "Caviste", alert: 12, lowStock: false, price: 3.5},
                    {name: "BIERES - Tsing Tao", quantity: 24, unit: "bouteilles", supplier: "Caviste", alert: 12, lowStock: false, price: 3.5},
                    {name: "BIERES - Saigon", quantity: 24, unit: "bouteilles", supplier: "Caviste", alert: 12, lowStock: false, price: 3.5},
                    {name: "LIMONADES JAPONAISES", quantity: 24, unit: "bouteilles", supplier: "Distributeur Asiatique", alert: 12, lowStock: false, price: 3.2},
                    {name: "INFUSION BIO ULTRA - One Piece", quantity: 10, unit: "boîtes", supplier: "Grossiste Bio", alert: 5, lowStock: false, price: 8.5},
                    {name: "INFUSION BIO ULTRA - DBZ", quantity: 10, unit: "boîtes", supplier: "Grossiste Bio", alert: 5, lowStock: false, price: 8.5},
                    {name: "INFUSION BIO ULTRA - My Hero Academia", quantity: 10, unit: "boîtes", supplier: "Grossiste Bio", alert: 5, lowStock: false, price: 8.5},
                    {name: "INFUSION BIO ULTRA - Naruto", quantity: 10, unit: "boîtes", supplier: "Grossiste Bio", alert: 5, lowStock: false, price: 8.5}
                ]
            },
            
            // Commandes en cours
            orders: {},
            
            // Historique des mouvements
            history: [],
            
            // Obtenir tous les produits en alerte de stock bas
            getLowStockProducts: function() {
                let alerts = [];
                for (const category in this.categories) {
                    const lowStockProducts = this.categories[category].filter(product => 
                        product.quantity <= product.alert
                    ).map(product => ({...product, category}));
                    
                    alerts = alerts.concat(lowStockProducts);
                }
                return alerts;
            },
            
            // Obtenir le nombre total de produits
            getTotalProducts: function() {
                let total = 0;
                for (const category in this.categories) {
                    total += this.categories[category].length;
                }
                return total;
            },
            
            // Obtenir le nombre total de commandes
            getTotalOrders: function() {
                let total = 0;
                for (const category in this.orders) {
                    total += this.orders[category].length;
                }
                return total;
            },
            
            // Mettre à jour un produit existant
            updateProduct: function(category, productName, updates) {
                const products = this.categories[category];
                const index = products.findIndex(p => p.name === productName);
                
                if (index !== -1) {
                    const oldQuantity = products[index].quantity;
                    products[index] = {...products[index], ...updates};
                    // Mettre à jour le statut de stock bas
                    products[index].lowStock = products[index].quantity <= products[index].alert;
                    
                    // Ajouter à l'historique si la quantité a changé
                    if (oldQuantity !== updates.quantity && updates.quantity !== undefined) {
                        this.addToHistory({
                            date: new Date(),
                            product: productName,
                            category: category,
                            action: oldQuantity < updates.quantity ? 'ajout' : 'retrait',
                            quantity: Math.abs(oldQuantity - updates.quantity),
                            unit: products[index].unit
                        });
                    }
                    
                    // Sauvegarder les données
                    this.saveData();
                    return true;
                }
                
                return false;
            },
            
            // Ajouter un nouveau produit
            addProduct: function(category, product) {
                try {
                    console.log("Ajout du produit:", product, "dans la catégorie:", category);
                    
                    // Vérifier que la catégorie existe
                    if (!this.categories[category]) {
                        console.log("Création de la catégorie:", category);
                        this.categories[category] = [];
                    }
                    
                    // Vérifier si le produit existe déjà
                    const existingIndex = this.categories[category].findIndex(p => p.name === product.name);
                    
                    if (existingIndex !== -1) {
                        console.log("Mise à jour du produit existant");
                        // Si la quantité a changé, ajouter à l'historique
                        const oldQuantity = this.categories[category][existingIndex].quantity;
                        if (oldQuantity !== product.quantity) {
                            this.addToHistory({
                                date: new Date(),
                                product: product.name,
                                category: category,
                                action: oldQuantity < product.quantity ? 'ajout' : 'retrait',
                                quantity: Math.abs(oldQuantity - product.quantity),
                                unit: product.unit
                            });
                        }
                        
                        // Mettre à jour le produit existant
                        this.categories[category][existingIndex] = {...product};
                    } else {
                        console.log("Ajout d'un nouveau produit");
                        // Ajouter un nouveau produit
                        this.categories[category].push({...product, lowStock: product.quantity <= product.alert});
                        
                        // Ajouter à l'historique
                        this.addToHistory({
                            date: new Date(),
                            product: product.name,
                            category: category,
                            action: 'création',
                            quantity: product.quantity,
                            unit: product.unit
                        });
                    }
                    
                    // Sauvegarder les données
                    const saved = this.saveData();
                    console.log("Données sauvegardées:", saved);
                    
                    return true;
                } catch (error) {
                    console.error("Erreur lors de l'ajout du produit:", error);
                    return false;
                }
            },
            
            // Ajouter un produit à la liste de commandes
            addToOrder: function(category, productName) {
                const product = this.categories[category].find(p => p.name === productName);
                
                if (product) {
                    if (!this.orders[category]) {
                        this.orders[category] = [];
                    }
                    
                    // Vérifier si le produit est déjà dans la commande
                    const existingIndex = this.orders[category].findIndex(p => p.name === productName);
                    
                    if (existingIndex === -1) {
                        this.orders[category].push({...product, category});
                        
                        // Ajouter à l'historique
                        this.addToHistory({
                            date: new Date(),
                            product: productName,
                            category: category,
                            action: 'commande',
                            quantity: product.quantity,
                            unit: product.unit
                        });
                        
                        this.saveData();
                        return true;
                    }
                }
                
                return false;
            },
            
            // Supprimer un produit de la liste de commandes
            removeFromOrder: function(category, productName) {
                if (this.orders[category]) {
                    const index = this.orders[category].findIndex(p => p.name === productName);
                    
                    if (index !== -1) {
                        this.orders[category].splice(index, 1);
                        
                        // Ajouter à l'historique
                        this.addToHistory({
                            date: new Date(),
                            product: productName,
                            category: category,
                            action: 'annulation commande',
                            quantity: 0,
                            unit: ''
                        });
                        
                        // Supprimer la catégorie si elle est vide
                        if (this.orders[category].length === 0) {
                            delete this.orders[category];
                        }
                        
                        this.saveData();
                        return true;
                    }
                }
                
                return false;
            },
            
            // Obtenir toutes les commandes groupées par catégorie
            getOrdersByCategory: function() {
                return this.orders;
            },
            
            // Ajouter à l'historique
            addToHistory: function(entry) {
                // S'assurer que l'historique existe
                if (!this.history) {
                    this.history = [];
                }
                
                // Ajouter l'entrée à l'historique
                this.history.push(entry);
                
                // Limiter l'historique à 1000 entrées pour éviter des problèmes de performance
                if (this.history.length > 1000) {
                    this.history = this.history.slice(-1000);
                }
                
                this.saveData();
            },
            
            // Réinitialiser l'historique
            resetHistory: function() {
                this.history = [];
                this.saveData();
                return true;
            },
            
            // Sauvegarder les données dans localStorage
            saveData: function() {
                try {
                    if (typeof localStorage === 'undefined') {
                        console.warn('LocalStorage n\'est pas disponible dans cet environnement');
                        return false;
                    }
                    
                    console.log("Sauvegarde des données...");
                    console.log("Catégories:", this.categories);
                    
                    localStorage.setItem('greenSushiStockData', JSON.stringify(this.categories));
                    localStorage.setItem('greenSushiOrdersData', JSON.stringify(this.orders));
                    localStorage.setItem('greenSushiHistoryData', JSON.stringify(this.history));
                    
                    console.log("Données sauvegardées avec succès");
                    return true;
                } catch (e) {
                    console.error('Erreur lors de la sauvegarde des données', e);
                    return false;
                }
            },
            
            // Charger les données depuis localStorage
            loadData: function() {
                try {
                    if (typeof localStorage === 'undefined') {
                        console.warn('LocalStorage n\'est pas disponible dans cet environnement');
                        return false;
                    }
                    
                    console.log("Chargement des données...");
                    
                    const stockData = localStorage.getItem('greenSushiStockData');
                    const ordersData = localStorage.getItem('greenSushiOrdersData');
                    const historyData = localStorage.getItem('greenSushiHistoryData');
                    
                    console.log("Données stockées:", stockData ? "Présentes" : "Absentes");
                    
                    if (stockData) {
                        this.categories = JSON.parse(stockData);
                    }
                    
                    if (ordersData) {
                        this.orders = JSON.parse(ordersData);
                    }
                    
                    if (historyData) {
                        this.history = JSON.parse(historyData);
                    } else {
                        // Initialiser l'historique si c'est la première fois
                        this.history = [];
                    }
                    
                    return !!stockData && !!ordersData;
                } catch (e) {
                    console.error('Erreur lors du chargement des données', e);
                    return false;
                }
            },
            
            // Réinitialiser les données démo
            resetToDemo: function() {
                this.categories = {
                    'Stock Frais': [
                        {name: "Oeufs", quantity: 2, unit: "boîte de 6", supplier: "Métro", alert: 1, lowStock: false, price: 3.5},
                        {name: "Moutarde", quantity: 2, unit: "pot", supplier: "Promocash", alert: 1, lowStock: false, price: 2.8},
                        {name: "Tomate séchée", quantity: 2, unit: "pot", supplier: "Métro", alert: 1, lowStock: false, price: 4.2},
                        {name: "Piment d'Espelette", quantity: 2, unit: "pot", supplier: "Grossiste Bio", alert: 1, lowStock: false, price: 5.8},
                        {name: "Fromage carré crémeux", quantity: 15, unit: "boîtes", supplier: "Fromager Local", alert: 10, lowStock: false, price: 3.2},
                        {name: "Cheddar en tranche", quantity: 8, unit: "paquets", supplier: "Fromager Local", alert: 5, lowStock: false, price: 4.5},
                        {name: "Emmental en bloc", quantity: 2, unit: "bloc", supplier: "Fromager Local", alert: 1, lowStock: false, price: 12.5},
                        {name: "Concombre", quantity: 15, unit: "pièces", supplier: "Grossiste Bio", alert: 10, lowStock: false, price: 1.2},
                        {name: "Avocat", quantity: 7, unit: "pièces", supplier: "Grossiste Bio", alert: 5, lowStock: false, price: 2.5},
                        {name: "Oignon peyi", quantity: 1.5, unit: "kg", supplier: "Grossiste Bio", alert: 1, lowStock: false, price: 3.9},
                        {name: "Oignon rouge", quantity: 15, unit: "pièces", supplier: "Grossiste Bio", alert: 10, lowStock: false, price: 0.8},
                        {name: "Carottes", quantity: 4, unit: "pièces", supplier: "Grossiste Bio", alert: 2, lowStock: false, price: 0.6},
                        {name: "Chou rouge", quantity: 2, unit: "pièces", supplier: "Grossiste Bio", alert: 1, lowStock: false, price: 3.2},
                        {name: "Navet", quantity: 3, unit: "pièces", supplier: "Grossiste Bio", alert: 2, lowStock: false, price: 0.9}
                    ],
                    'Stock Surgelé': [
                        {name: "Boîte de crevettes tempura", quantity: 15, unit: "boîtes", supplier: "Poissonnerie Maritime", alert: 10, lowStock: false, price: 25.5},
                        {name: "Sachet de gyoza", quantity: 8, unit: "sachets", supplier: "Distributeur Asiatique", alert: 5, lowStock: false, price: 18.2},
                        {name: "Sachet de wakame", quantity: 7, unit: "sachets", supplier: "Distributeur Asiatique", alert: 5, lowStock: false, price: 12.5},
                        {name: "Carpaccio de boeuf", quantity: 2, unit: "sachet", supplier: "Promocash", alert: 1, lowStock: false, price: 22.9}
                    ],
                    'Stock Sec': [
                        {name: "Riz", quantity: 45, unit: "kg", supplier: "Distributeur Asiatique", alert: 40, lowStock: false, price: 3.8},
                        {name: "Sachet de panure Panko", quantity: 8, unit: "sachets", supplier: "Distributeur Asiatique", alert: 5, lowStock: false, price: 6.2},
                        {name: "Feuille d'algue nori", quantity: 7, unit: "sachets", supplier: "Distributeur Asiatique", alert: 5, lowStock: false, price: 15.8},
                        {name: "Sachet de gingembre mariné", quantity: 8, unit: "sachets", supplier: "Distributeur Asiatique", alert: 5, lowStock: false, price: 8.9},
                        {name: "Wasabi en poudre", quantity: 4, unit: "sachets", supplier: "Distributeur Asiatique", alert: 3, lowStock: false, price: 7.5},
                        {name: "Sauce soja Kikoman", quantity: 2, unit: "bidons de 20L", supplier: "Distributeur Asiatique", alert: 1, lowStock: false, price: 48.5},
                        {name: "Sauce Sweet", quantity: 2, unit: "bidon de 5L", supplier: "Distributeur Asiatique", alert: 1, lowStock: false, price: 22.9},
                        {name: "Sauce Sriracha", quantity: 2, unit: "bidon de 5L", supplier: "Distributeur Asiatique", alert: 1, lowStock: false, price: 19.8},
                        {name: "Vinaigre blanc", quantity: 2, unit: "bidons de 10L", supplier: "Métro", alert: 1, lowStock: false, price: 12.4},
                        {name: "Sucre blanc", quantity: 15, unit: "kg", supplier: "Métro", alert: 10, lowStock: false, price: 1.8},
                        {name: "Sucre roux", quantity: 15, unit: "kg", supplier: "Métro", alert: 10, lowStock: false, price: 2.2},
                        {name: "Huile de tournesol", quantity: 25, unit: "L", supplier: "Métro", alert: 20, lowStock: false, price: 3.5},
                        {name: "Farine", quantity: 8, unit: "kg", supplier: "Métro", alert: 5, lowStock: false, price: 1.6}
                    ],
                    'Stock Consommable': [
                        {name: "Baguettes chinoises", quantity: 15, unit: "sachets", supplier: "Distributeur Asiatique", alert: 10, lowStock: false, price: 5.9},
                        {name: "Film transparent", quantity: 2, unit: "rouleau", supplier: "Fournitures Pro", alert: 1, lowStock: false, price: 8.5},
                        {name: "Papier aluminium", quantity: 2, unit: "rouleau", supplier: "Fournitures Pro", alert: 1, lowStock: false, price: 7.8},
                        {name: "Sachet kraft grand format", quantity: 3, unit: "cartons", supplier: "Fournitures Pro", alert: 2, lowStock: false, price: 42.5},
                        {name: "Sachet kraft petit format", quantity: 3, unit: "cartons", supplier: "Fournitures Pro", alert: 2, lowStock: false, price: 35.9},
                        {name: "Plateaux ronds à sushi", quantity: 2, unit: "carton", supplier: "Distributeur Asiatique", alert: 1, lowStock: false, price: 65.2},
                        {name: "Produit pour le sol", quantity: 2, unit: "bidon", supplier: "Fournitures Pro", alert: 1, lowStock: false, price: 12.5},
                        {name: "Tête de serpillère", quantity: 3, unit: "exemplaires", supplier: "Fournitures Pro", alert: 2, lowStock: false, price: 6.8},
                        {name: "Produit lave-vaisselle", quantity: 2, unit: "sachet", supplier: "Fournitures Pro", alert: 1, lowStock: false, price: 15.9},
                        {name: "Boîte de gants (par taille)", quantity: 5, unit: "boîtes", supplier: "Fournitures Pro", alert: 3, lowStock: false, price: 9.5}
                    ],
                    'Stock Boissons': [
                        {name: "MR BASIL - Maracudja", quantity: 10, unit: "bouteilles", supplier: "Distriboissons", alert: 5, lowStock: false, price: 4.2},
                        {name: "MR BASIL - Mangue", quantity: 10, unit: "bouteilles", supplier: "Distriboissons", alert: 5, lowStock: false, price: 4.2},
                        {name: "MR BASIL - Grenade", quantity: 10, unit: "bouteilles", supplier: "Distriboissons", alert: 5, lowStock: false, price: 4.2},
                        {name: "MR BASIL - Kiwi", quantity: 10, unit: "bouteilles", supplier: "Distriboissons", alert: 5, lowStock: false, price: 4.2},
                        {name: "MR BASIL - Cocktails", quantity: 10, unit: "bouteilles", supplier: "Distriboissons", alert: 5, lowStock: false, price: 4.8},
                        {name: "KEFWI - Lanmou Red", quantity: 10, unit: "bouteilles", supplier: "Distriboissons", alert: 5, lowStock: false, price: 4.5},
                        {name: "KEFWI - Soley Cho", quantity: 10, unit: "bouteilles", supplier: "Distriboissons", alert: 5, lowStock: false, price: 4.5},
                        {name: "KEFWI - Power Flower", quantity: 10, unit: "bouteilles", supplier: "Distriboissons", alert: 5, lowStock: false, price: 4.5},
                        {name: "KEFWI - Fwisson", quantity: 10, unit: "bouteilles", supplier: "Distriboissons", alert: 5, lowStock: false, price: 4.5},
                        {name: "KEFWI - Ginger Beer", quantity: 10, unit: "bouteilles", supplier: "Distriboissons", alert: 5, lowStock: false, price: 4.5},
                        {name: "KEFWI - Golden Dousse", quantity: 10, unit: "bouteilles", supplier: "Distriboissons", alert: 5, lowStock: false, price: 4.5},
                        {name: "BIERES - Asahi", quantity: 24, unit: "bouteilles", supplier: "Caviste", alert: 12, lowStock: false, price: 3.9},
                        {name: "BIERES - Kirin", quantity: 24, unit: "bouteilles", supplier: "Caviste", alert: 12, lowStock: false, price: 3.9},
                        {name: "BIERES - Sapporo", quantity: 24, unit: "bouteilles", supplier: "Caviste", alert: 12, lowStock: false, price: 3.9},
                        {name: "BIERES - Chang", quantity: 24, unit: "bouteilles", supplier: "Caviste", alert: 12, lowStock: false, price: 3.5},
                        {name: "BIERES - Tsing Tao", quantity: 24, unit: "bouteilles", supplier: "Caviste", alert: 12, lowStock: false, price: 3.5},
                        {name: "BIERES - Saigon", quantity: 24, unit: "bouteilles", supplier: "Caviste", alert: 12, lowStock: false, price: 3.5},
                        {name: "LIMONADES JAPONAISES", quantity: 24, unit: "bouteilles", supplier: "Distributeur Asiatique", alert: 12, lowStock: false, price: 3.2},
                        {name: "INFUSION BIO ULTRA - One Piece", quantity: 10, unit: "boîtes", supplier: "Grossiste Bio", alert: 5, lowStock: false, price: 8.5},
                        {name: "INFUSION BIO ULTRA - DBZ", quantity: 10, unit: "boîtes", supplier: "Grossiste Bio", alert: 5, lowStock: false, price: 8.5},
                        {name: "INFUSION BIO ULTRA - My Hero Academia", quantity: 10, unit: "boîtes", supplier: "Grossiste Bio", alert: 5, lowStock: false, price: 8.5},
                        {name: "INFUSION BIO ULTRA - Naruto", quantity: 10, unit: "boîtes", supplier: "Grossiste Bio", alert: 5, lowStock: false, price: 8.5}
                    ]
                };
                
            // Créer quelques commandes par défaut
                this.orders = {
                    'Stock Frais': [
                        {name: "Oeufs", quantity: 2, unit: "boîte de 6", supplier: "Métro", alert: 1, category: 'Stock Frais', price: 3.5}
                    ],
                    'Stock Surgelé': [
                        {name: "Sachet de gyoza", quantity: 8, unit: "sachets", supplier: "Distributeur Asiatique", alert: 5, category: 'Stock Surgelé', price: 18.2}
                    ],
                    'Stock Boissons': [
                        {name: "BIERES - Asahi", quantity: 24, unit: "bouteilles", supplier: "Caviste", alert: 12, category: 'Stock Boissons', price: 3.9}
                    ]
                };
                
                // Initialiser l'historique avec quelques entrées démo
                const now = new Date();
                this.history = [
                    {
                        date: new Date(now.getTime() - 1 * 24 * 60 * 60 * 1000),
                        product: "Riz",
                        category: "Stock Sec",
                        action: "ajout",
                        quantity: 5,
                        unit: "kg"
                    },
                    {
                        date: new Date(now.getTime() - 2 * 24 * 60 * 60 * 1000),
                        product: "Fromage",
                        category: "Stock Frais",
                        action: "retrait",
                        quantity: 2,
                        unit: "kg"
                    },
                    {
                        date: new Date(now.getTime() - 5 * 24 * 60 * 60 * 1000),
                        product: "Coca-Cola",
                        category: "Stock Boissons",
                        action: "commande",
                        quantity: 6,
                        unit: "packs"
                    }
                ];
                
                this.saveData();
            }
        };
        
        // ------------------------------
        // FONCTIONS DE RENDU DES TEMPLATES
        // ------------------------------
        
        // Initialiser le formulaire de produit
        function prepareProductForm(product = null) {
            // Remplir le select des fournisseurs
            const supplierSelect = document.getElementById('product-supplier');
            supplierSelect.innerHTML = '';
            
            // Option vide
            const emptyOption = document.createElement('option');
            emptyOption.value = '';
            emptyOption.textContent = '-- Choisir un fournisseur --';
            supplierSelect.appendChild(emptyOption);
            
            // Ajout des fournisseurs existants
            StockData.suppliers.forEach(supplier => {
                const option = document.createElement('option');
                option.value = supplier;
                option.textContent = supplier;
                supplierSelect.appendChild(option);
            });
            
            // Si c'est une édition, sélectionner le fournisseur du produit
            if (product) {
                document.getElementById('product-name').value = product.name;
                document.getElementById('product-quantity').value = product.quantity;
                document.getElementById('product-unit').value = product.unit;
                document.getElementById('product-alert').value = product.alert;
                document.getElementById('product-supplier').value = product.supplier;
                document.getElementById('product-original-name').value = product.name;
                document.getElementById('form-title').textContent = 'Modifier Produit';
            } else {
                document.getElementById('product-form').reset();
                document.getElementById('form-title').textContent = 'Ajouter Produit';
                document.getElementById('product-original-name').value = '';
            }
        }
        
        // Template pour un produit
        function createProductTemplate(product, actions, isInOrder = false) {
            // Déterminer si le produit est déjà dans la commande
            const orderIcon = isInOrder ? '✓' : '📋';
            const orderButtonHtml = `<button class="order-button ${isInOrder ? 'active' : ''}">${orderIcon}</button>`;
            
            return `
                <div class="product-item">
                    <div class="reorder-buttons">
                        <button class="reorder-button move-up" title="Déplacer vers le haut">▲</button>
                        <button class="reorder-button move-down" title="Déplacer vers le bas">▼</button>
                    </div>
                    <div class="product-info">
                        <div class="product-name">${product.name}</div>
                        <div class="product-supplier">${product.supplier}</div>
                    </div>
                    <div class="product-controls">
                        <div class="product-quantity ${product.quantity <= product.alert ? 'low-stock' : ''}">${product.quantity} ${product.unit}</div>
                        <div class="quantity-controls">
                            <button class="quantity-button quantity-up">▲</button>
                            <button class="quantity-button quantity-down">▼</button>
                        </div>
                        <input type="number" class="stock-input" value="${product.quantity}" min="0">
                        <div class="product-unit">${product.unit}</div>
                    </div>
                    <div class="product-actions">
                        ${actions.includes('order-button') ? orderButtonHtml : actions}
                    </div>
                </div>
            `;
        }
        
        // Fonction pour afficher une notification
        function showNotification(message, duration = 2000) {
            const notification = document.getElementById('inventory-notification');
            notification.textContent = message;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, duration);
        }
        
        // Fonction pour afficher un popup au centre de l'écran
        function showPopup(message, duration = 1500) {
            const popup = document.getElementById('popup');
            popup.textContent = message;
            popup.classList.add('popup-animation');
            
            setTimeout(() => {
                popup.classList.remove('popup-animation');
            }, duration);
        }
        
        // Fonction pour formater une date
        function formatDate(date) {
            if (!date) return 'Date inconnue';
            
            const d = new Date(date);
            if (isNaN(d.getTime())) return 'Date invalide';
            
            return d.toLocaleDateString('fr-FR', { 
                day: '2-digit', 
                month: '2-digit', 
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        // Fonction pour attacher les événements aux éléments d'un produit
        function attachProductEvents(productElement, product, category) {
            const orderButton = productElement.querySelector('.order-button');
            const editButton = productElement.querySelector('.edit-button');
            const stockInput = productElement.querySelector('.stock-input');
            const quantityDisplay = productElement.querySelector('.product-quantity');
            const increaseButton = productElement.querySelector('.quantity-up');
            const decreaseButton = productElement.querySelector('.quantity-down');
            const moveUpButton = productElement.querySelector('.move-up');
            const moveDownButton = productElement.querySelector('.move-down');
            
            // Gérer le déplacement du produit vers le haut
            if (moveUpButton) {
                moveUpButton.addEventListener('click', function(e) {
                    e.stopPropagation();
                    
                    // Déplacer le produit vers le haut dans le modèle de données
                    if (StockData.moveProduct(category, product.name, 'up')) {
                        // Mettre à jour l'affichage
                        renderProductsList(category);
                        
                        // Notification
                        showPopup(`${product.name} déplacé vers le haut`);
                    }
                });
            }
            
            // Gérer le déplacement du produit vers le bas
            if (moveDownButton) {
                moveDownButton.addEventListener('click', function(e) {
                    e.stopPropagation();
                    
                    // Déplacer le produit vers le bas dans le modèle de données
                    if (StockData.moveProduct(category, product.name, 'down')) {
                        // Mettre à jour l'affichage
                        renderProductsList(category);
                        
                        // Notification
                        showPopup(`${product.name} déplacé vers le bas`);
                    }
                });
            }
            
            // Gérer le bouton de commande
            orderButton.addEventListener('click', function() {
                // Animation de l'icône
                this.classList.add('pulse');
                setTimeout(() => this.classList.remove('pulse'), 500);
                
                // Basculer l'état actif
                this.classList.toggle('active');
                
                if (this.classList.contains('active')) {
                    // Changer l'icône
                    this.textContent = '✓';
                    
                    // Ajouter à la commande
                    StockData.addToOrder(category, product.name);
                    
                    // Notification plus visible
                    showPopup(`${product.name} ajouté à la commande`);
                } else {
                    // Changer l'icône
                    this.textContent = '📋';
                    
                    // Retirer de la commande
                    StockData.removeFromOrder(category, product.name);
                    showNotification('Produit retiré de la commande');
                }
                
                // Mettre à jour les statistiques
                updateStats();
            });
            
            // Vérifier si le produit est déjà dans la commande
            if (StockData.orders[category] && StockData.orders[category].some(p => p.name === product.name)) {
                orderButton.classList.add('active');
            }
            
            // Gérer le bouton d'édition
            editButton.addEventListener('click', function() {
                try {
                    // Préparer le formulaire d'édition avec les données du produit
                    prepareProductForm(product);
                    document.getElementById('product-category').value = category;
                    
                    showPage('add-product-page');
                } catch (error) {
                    console.error('Erreur lors de l\'édition:', error);
                    showNotification('Erreur lors de l\'édition du produit');
                }
            });
            
            // Gérer le double-clic sur la quantité pour afficher l'input
            quantityDisplay.addEventListener('dblclick', function() {
                this.style.display = 'none';
                stockInput.style.display = 'inline-block';
                stockInput.focus();
                stockInput.select();
            });
            
            // Bouton d'augmentation de la quantité
            increaseButton.addEventListener('click', function() {
                // Récupérer la quantité actuelle
                const currentProduct = StockData.categories[category].find(p => p.name === product.name);
                if (!currentProduct) return;
                
                const newQuantity = currentProduct.quantity + 1;
                
                // Mettre à jour dans le modèle de données
                StockData.updateProduct(category, product.name, {quantity: newQuantity});
                
                // Mettre à jour l'affichage
                quantityDisplay.textContent = newQuantity + ' ' + product.unit;
                quantityDisplay.classList.toggle('low-stock', newQuantity <= currentProduct.alert);
                stockInput.value = newQuantity;
                
                // Animation de confirmation
                this.classList.add('pulse');
                setTimeout(() => this.classList.remove('pulse'), 300);
                
                // Notification
                showPopup(`${product.name}: +1 ${product.unit}`);
                
                // Mettre à jour le compteur d'alertes
                updateAlertCount();
                
                // Mettre à jour les statistiques
                updateStats();
                
                // Mettre à jour l'historique
                renderHistory('week');
            });
            
            // Bouton de diminution de la quantité
            decreaseButton.addEventListener('click', function() {
                // Récupérer la quantité actuelle
                const currentProduct = StockData.categories[category].find(p => p.name === product.name);
                if (!currentProduct || currentProduct.quantity <= 0) return;
                
                const newQuantity = currentProduct.quantity - 1;
                
                // Mettre à jour dans le modèle de données
                StockData.updateProduct(category, product.name, {quantity: newQuantity});
                
                // Mettre à jour l'affichage
                quantityDisplay.textContent = newQuantity + ' ' + product.unit;
                quantityDisplay.classList.toggle('low-stock', newQuantity <= currentProduct.alert);
                stockInput.value = newQuantity;
                
                // Animation de confirmation
                this.classList.add('pulse');
                setTimeout(() => this.classList.remove('pulse'), 300);
                
                // Notification
                showPopup(`${product.name}: -1 ${product.unit}`);
                
                // Mettre à jour le compteur d'alertes
                updateAlertCount();
                
                // Mettre à jour les statistiques
                updateStats();
                
                // Mettre à jour l'historique
                renderHistory('week');
            });
            
            // Gérer la mise à jour de la quantité
            stockInput.addEventListener('change', function() {
                const newQuantity = parseInt(this.value) || 0;
                
                // Mettre à jour dans le modèle de données
                StockData.updateProduct(category, product.name, {quantity: newQuantity});
                
                // Mettre à jour l'affichage
                quantityDisplay.textContent = newQuantity + ' ' + product.unit;
                quantityDisplay.classList.toggle('low-stock', newQuantity <= product.alert);
                
                // Masquer l'input et afficher la valeur
                this.style.display = 'none';
                quantityDisplay.style.display = 'inline-block';
                
                // Notification
                showNotification('Stock mis à jour avec succès!');
                
                // Mettre à jour le compteur d'alertes
                updateAlertCount();
                
                // Mettre à jour les statistiques
                updateStats();
                
                // Mettre à jour l'historique
                renderHistory('week'); // Par défaut, afficher l'historique de la semaine
            });
            
            // Gérer la perte de focus sur l'input
            stockInput.addEventListener('blur', function() {
                this.style.display = 'none';
                quantityDisplay.style.display = 'inline-block';
            });
            
            // Gérer la touche Entrée sur l'input
            stockInput.addEventListener('keyup', function(e) {
                if (e.key === 'Enter') {
                    this.blur();
                }
            });
        }
        
        // Fonction pour mettre à jour le compteur d'alertes
        function updateAlertCount() {
            const alertCount = StockData.getLowStockProducts().length;
            document.getElementById('alert-count').textContent = alertCount;
        }
        
        // Fonction pour mettre à jour les statistiques
        function updateStats() {
            document.getElementById('stats-total-products').textContent = StockData.getTotalProducts();
            document.getElementById('stats-low-stock').textContent = StockData.getLowStockProducts().length;
            document.getElementById('stats-orders').textContent = StockData.getTotalOrders();
            
            // Calcul de la valeur estimée basée sur une formule plus simple et compréhensible
            let totalValue = 0;
            let totalProducts = 0;
            
            for (const category in StockData.categories) {
                StockData.categories[category].forEach(product => {
                    // On donne une valeur de base à chaque produit (20€) multipliée par sa quantité
                    // Pour les produits en stock bas, on valorise légèrement plus (urgence)
                    const baseValue = product.lowStock ? 25 : 20;
                    totalValue += product.quantity * baseValue;
                    totalProducts++;
                });
            }
            
            document.getElementById('stats-value').textContent = totalValue.toFixed(0) + ' €';
            
            // Mettre à jour l'explication
            const avgValue = totalProducts > 0 ? Math.round(totalValue / totalProducts) : 0;
            document.getElementById('stats-value-info').textContent = 
                `Valeur estimée: ${avgValue}€ par produit en moyenne`;
        }
        
        // Fonction pour afficher la liste des produits
        function renderProductsList(categoryTitle) {
            console.log("Rendu de la liste des produits pour la catégorie:", categoryTitle);
            
            const productsList = document.getElementById('products-list');
            productsList.innerHTML = '';
            
            if (!StockData.categories || !StockData.categories[categoryTitle] || StockData.categories[categoryTitle].length === 0) {
                console.log("Aucun produit dans cette catégorie");
                productsList.innerHTML = '<div class="empty-state">Aucun produit dans cette catégorie</div>';
                return;
            }
            
            console.log("Nombre de produits:", StockData.categories[categoryTitle].length);
            
            // Créer un fragment pour optimiser le DOM
            const fragment = document.createDocumentFragment();
            
            // Trier les produits (stock bas en premier)
            const sortedProducts = [...StockData.categories[categoryTitle]].sort((a, b) => {
                // D'abord par statut de stock bas
                if (a.quantity <= a.alert && b.quantity > b.alert) return -1;
                if (a.quantity > a.alert && b.quantity <= b.alert) return 1;
                // Ensuite par nom
                return a.name.localeCompare(b.name);
            });
            
            // Créer les éléments pour chaque produit
            sortedProducts.forEach(product => {
                console.log("Création de l'élément pour le produit:", product.name);
                
                // Vérifier si le produit est déjà dans la commande
                const isInOrder = StockData.orders[categoryTitle] && 
                                 StockData.orders[categoryTitle].some(p => p.name === product.name);
                
                const template = document.createElement('template');
                template.innerHTML = createProductTemplate(
                    product,
                    '<button class="order-button">📋</button><button class="edit-button">✏️</button>',
                    isInOrder
                );
                
                const productElement = template.content.firstElementChild;
                
                // Attacher les événements
                attachProductEvents(productElement, product, categoryTitle);
                
                // Ajouter au fragment
                fragment.appendChild(productElement);
            });
            
            // Ajouter le fragment au DOM
            productsList.appendChild(fragment);
        }
        
        // Fonction pour afficher les alertes
        function renderAlertsPage() {
            const alertsList = document.getElementById('alerts-list');
            alertsList.innerHTML = '';
            
            const alerts = StockData.getLowStockProducts();
            
            if (alerts.length === 0) {
                alertsList.innerHTML = '<div class="empty-state">Aucune alerte de stock bas</div>';
                return;
            }
            
            const fragment = document.createDocumentFragment();
            
            alerts.forEach(product => {
                // Vérifier si le produit est déjà dans la commande
                const isInOrder = StockData.orders[product.category] && 
                                 StockData.orders[product.category].some(p => p.name === product.name);
                
                const template = document.createElement('template');
                // Suppression du bouton d'édition, uniquement bouton de commande
                template.innerHTML = createProductTemplate(
                    product,
                    'order-button',
                    isInOrder
                );
                
                const alertElement = template.content.firstElementChild;
                
                // Modifier l'affichage du fournisseur pour inclure la catégorie
                const supplierInfo = alertElement.querySelector('.product-supplier');
                supplierInfo.textContent = `${product.category} - ${product.supplier}`;
                
                // Attacher uniquement l'événement pour le bouton de commande
                const orderButton = alertElement.querySelector('.order-button');
                orderButton.addEventListener('click', function() {
                    this.classList.toggle('active');
                    
                    if (this.classList.contains('active')) {
                        // Changer l'icône
                        this.textContent = '✓';
                        
                        // Ajouter à la commande
                        StockData.addToOrder(product.category, product.name);
                        showNotification('Produit ajouté à la commande');
                    } else {
                        // Changer l'icône
                        this.textContent = '📋';
                        
                        // Retirer de la commande
                        StockData.removeFromOrder(product.category, product.name);
                        showNotification('Produit retiré de la commande');
                    }
                    
                    // Mettre à jour les statistiques
                    updateStats();
                });
                
                // Vérifier si le produit est déjà dans la commande
                if (StockData.orders[product.category] && 
                    StockData.orders[product.category].some(p => p.name === product.name)) {
                    orderButton.classList.add('active');
                }
                
                fragment.appendChild(alertElement);
            });
            
            alertsList.appendChild(fragment);
        }
        
        // Fonction pour afficher les commandes
        function renderOrdersList() {
            const ordersList = document.getElementById('orders-list');
            ordersList.innerHTML = '';
            
            const orders = StockData.getOrdersByCategory();
            const categories = Object.keys(orders);
            
            if (categories.length === 0) {
                ordersList.innerHTML = '<div class="empty-state">Aucune commande en cours</div>';
                return;
            }
            
            const fragment = document.createDocumentFragment();
            
            // Créer les groupes de catégories
            categories.forEach(category => {
                const categoryGroup = document.createElement('div');
                categoryGroup.className = 'category-group';
                
                // Créer l'en-tête de catégorie
                const categoryIcon = 
                    category === 'Stock Sec' ? '🌾' : 
                    category === 'Stock Frais' ? '🧀' : 
                    category === 'Stock Surgelé' ? '❄️' : 
                    category === 'Stock Boissons' ? '🧃' : '🥢';
                
                const categoryHeader = document.createElement('div');
                categoryHeader.className = 'category-header';
                categoryHeader.innerHTML = `
                    <div>${categoryIcon} ${category} (${orders[category].length})</div>
                    <div class="toggle-icon">▼</div>
                `;
                
                // Créer le contenu de la catégorie
                const categoryContent = document.createElement('div');
                categoryContent.className = 'category-content';
                
                // Ajouter les produits
                orders[category].forEach(product => {
                    const template = document.createElement('template');
                    template.innerHTML = createProductTemplate(
                        product,
                        '<button class="order-button active">✓</button><button class="edit-button">✏️</button>',
                        true
                    );
                    
                    const orderElement = template.content.firstElementChild;
                    
                    // Attacher les événements
                    const orderButton = orderElement.querySelector('.order-button');
                    const editButton = orderElement.querySelector('.edit-button');
                    
                    // Retirer de la commande
                    orderButton.addEventListener('click', function() {
                        this.classList.toggle('active');
                        
                        if (!this.classList.contains('active')) {
                            // Changer l'icône
                            this.textContent = '📋';
                            
                            // Retirer de la commande
                            StockData.removeFromOrder(category, product.name);
                            orderElement.remove();
                            
                            // Si la catégorie est vide, supprimer le groupe
                            if (!StockData.orders[category] || StockData.orders[category].length === 0) {
                                categoryGroup.remove();
                            } else {
                                // Mettre à jour le compteur
                                categoryHeader.querySelector('div').textContent = `${categoryIcon} ${category} (${StockData.orders[category].length})`;
                            }
                            
                            showNotification('Produit retiré de la commande');
                            
                            // Mettre à jour les statistiques
                            updateStats();
                        }
                    });
                    
                    // Édition du produit
                    editButton.addEventListener('click', function() {
                        prepareProductForm(product);
                        document.getElementById('product-category').value = category;
                        
                        showPage('add-product-page');
                    });
                    
                    categoryContent.appendChild(orderElement);
                });
                
                // Ajouter l'événement de toggle à l'en-tête
                categoryHeader.addEventListener('click', function() {
                    categoryContent.style.display = categoryContent.style.display === 'none' ? 'block' : 'none';
                    this.querySelector('.toggle-icon').textContent = categoryContent.style.display === 'none' ? '▶' : '▼';
                });
                
                // Assembler le groupe
                categoryGroup.appendChild(categoryHeader);
                categoryGroup.appendChild(categoryContent);
                fragment.appendChild(categoryGroup);
            });
            
            ordersList.appendChild(fragment);
        }
        
        // Fonction pour afficher l'historique des mouvements
        function renderHistory(period) {
            const historyList = document.getElementById('history-list');
            historyList.innerHTML = '';
            
            const history = StockData.getHistory(period);
            
            if (history.length === 0) {
                historyList.innerHTML = '<div class="empty-state">Aucun mouvement dans cette période</div>';
                return;
            }
            
            const fragment = document.createDocumentFragment();
            
            history.forEach(entry => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                
                // Créer l'en-tête avec la date
                const historyDate = document.createElement('div');
                historyDate.className = 'history-date';
                historyDate.textContent = formatDate(entry.date);
                
                // Créer le contenu avec l'action
                const historyContent = document.createElement('div');
                historyContent.className = 'history-content';
                
                    const actionText = 
                    entry.action === 'ajout' ? 'Ajout de' :
                    entry.action === 'retrait' ? 'Retrait de' :
                    entry.action === 'création' ? 'Création de' :
                    entry.action === 'commande' ? 'Commande de' : 
                    entry.action === 'renommage' ? 'Renommage de' :
                    entry.action === 'annulation commande' ? 'Annulation de commande de' :
                    'Action sur';
                
                // Histoire avec détails additionnels si présents
                historyContent.innerHTML = `
                    <span class="history-action">${actionText}</span>
                    <strong>${entry.product}</strong>
                    ${entry.quantity ? `(${entry.quantity} ${entry.unit})` : ''}
                    <div class="history-details">
                        Catégorie: ${entry.category}
                        ${entry.details ? `<br>${entry.details}` : ''}
                    </div>
                `;
                
                // Assembler l'élément d'historique
                historyItem.appendChild(historyDate);
                historyItem.appendChild(historyContent);
                fragment.appendChild(historyItem);
            });
            
            historyList.appendChild(fragment);
        }
        
        // ------------------------------
        // FONCTIONS DE NAVIGATION
        // ------------------------------
        
        // Fonction pour afficher une page
        function showPage(pageId) {
            try {
                console.log("Affichage de la page:", pageId);
                
                const pages = document.querySelectorAll('.page');
                pages.forEach(page => {
                    page.classList.remove('active');
                });
                
                const pageToShow = document.getElementById(pageId);
                if (!pageToShow) {
                    console.error("Page introuvable:", pageId);
                    return;
                }
                
                pageToShow.classList.add('active');
                
                // Actions spécifiques à certaines pages
                if (pageId === 'alerts-page') {
                    renderAlertsPage();
                } else if (pageId === 'orders-page') {
                    renderOrdersList();
                } else if (pageId === 'stats-page') {
                    updateStats();
                    renderHistory('week'); // Par défaut, afficher l'historique de la semaine
                }
            } catch (error) {
                console.error("Erreur lors de l'affichage de la page:", error);
            }
        }
        
        // Fonction pour activer un onglet
        function activateTab(pageId) {
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelector(`.tab[data-page="${pageId}"]`).classList.add('active');
        }
        
        // ------------------------------
        // INITIALISATION DE L'APPLICATION
        // ------------------------------
        
        function initApp() {
            try {
                console.log("Initialisation de l'application...");
                
                // TOUJOURS réinitialiser aux données démo pour GitHub Pages
                console.log("Initialisation des données démo");
                StockData.resetToDemo();
                
                // Initialiser le compteur d'alertes
                updateAlertCount();
                
                console.log("Données chargées :", StockData.categories);
                
                // Navigation entre les pages via les onglets
                const tabs = document.querySelectorAll('.tab');
                tabs.forEach(tab => {
                    tab.addEventListener('click', function() {
                        const pageId = this.dataset.page;
                        showPage(pageId);
                        activateTab(pageId);
                    });
                });
            
            // Délégation d'événements pour les catégories sur la page d'accueil
            document.getElementById('categories-container').addEventListener('click', function(event) {
                try {
                    const card = event.target.closest('.category-card');
                    if (!card) return;
                    
                    console.log("Clic sur une catégorie:", card.dataset.category);
                    
                    const category = card.dataset.category;
                    if (category === 'commandes') {
                        showPage('orders-page');
                        activateTab('orders-page');
                    } else {
                        let categoryTitle;
                        
                        switch(category) {
                            case 'sec':
                                categoryTitle = 'Stock Sec';
                                break;
                            case 'frais':
                                categoryTitle = 'Stock Frais';
                                break;
                            case 'surgele':
                                categoryTitle = 'Stock Surgelé';
                                break;
                            case 'boissons':
                                categoryTitle = 'Stock Boissons';
                                break;
                            case 'consommable':
                                categoryTitle = 'Stock Consommable';
                                break;
                            default:
                                categoryTitle = 'Stock ' + category.charAt(0).toUpperCase() + category.slice(1);
                        }
                        
                        console.log("Titre de la catégorie:", categoryTitle);
                        
                        // Vérifier que la catégorie existe
                        if (!StockData.categories[categoryTitle]) {
                            console.log("La catégorie n'existe pas, création de la catégorie vide");
                            StockData.categories[categoryTitle] = [];
                            StockData.saveData();
                        }
                        
                        document.getElementById('category-title').textContent = categoryTitle;
                        showPage('products-page');
                        renderProductsList(categoryTitle);
                    }
                } catch (error) {
                    console.error("Erreur lors du clic sur une catégorie:", error);
                    alert("Une erreur est survenue. Veuillez rafraîchir la page.");
                }
            });
            
            // Filtres de l'historique
            document.querySelector('.history-filters').addEventListener('click', function(event) {
                if (event.target.classList.contains('history-filter')) {
                    // Retirer la classe active de tous les filtres
                    document.querySelectorAll('.history-filter').forEach(filter => {
                        filter.classList.remove('active');
                    });
                    
                    // Ajouter la classe active au filtre cliqué
                    event.target.classList.add('active');
                    
                    // Afficher l'historique selon la période sélectionnée
                    renderHistory(event.target.dataset.period);
                }
            });
            
            // Boutons de retour
            document.getElementById('back-to-home').addEventListener('click', function() {
                showPage('home-page');
                activateTab('home-page');
            });
            
            document.getElementById('back-to-products').addEventListener('click', function() {
                const category = document.getElementById('product-category').value || document.getElementById('category-title').textContent;
                showPage('products-page');
                renderProductsList(category);
            });
            
            // Bouton d'ajout de produit
            document.getElementById('add-product').addEventListener('click', function() {
                try {
                    console.log("Clic sur le bouton d'ajout de produit");
                    
                    // Réinitialiser le formulaire
                    prepareProductForm();
                    
                    // Récupérer la catégorie active
                    const categoryTitle = document.getElementById('category-title');
                    const categoryValue = categoryTitle ? categoryTitle.textContent : '';
                    
                    console.log("Catégorie active:", categoryValue);
                    
                    if (categoryValue && document.getElementById('product-category')) {
                        document.getElementById('product-category').value = categoryValue;
                    }
                    
                    // S'assurer que tous les champs sont vides
                    document.getElementById('product-name').value = '';
                    document.getElementById('product-quantity').value = '0';
                    document.getElementById('product-unit').value = '';
                    document.getElementById('product-alert').value = '0';
                    document.getElementById('product-supplier').value = '';
                    document.getElementById('product-price').value = '0';
                    document.getElementById('product-original-name').value = '';
                    document.getElementById('form-title').textContent = 'Ajouter Produit';
                    
                    // Afficher la page d'ajout de produit
                    showPage('add-product-page');
                } catch (error) {
                    console.error('Erreur lors de l\'ajout:', error);
                    showNotification('Erreur lors de l\'ajout d\'un produit: ' + error.message, 3000);
                }
            });
            
            // Annulation du formulaire
            document.getElementById('cancel-add').addEventListener('click', function() {
                const category = document.getElementById('product-category').value || document.getElementById('category-title').textContent;
                showPage('products-page');
                renderProductsList(category);
            });
            
            // Soumission du formulaire
            document.getElementById('product-form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                try {
                    console.log("Soumission du formulaire de produit");
                    
                    const name = document.getElementById('product-name').value;
                    const quantity = parseInt(document.getElementById('product-quantity').value) || 0;
                    const unit = document.getElementById('product-unit').value;
                    const alert = parseInt(document.getElementById('product-alert').value) || 0;
                    const supplier = document.getElementById('product-supplier').value;
                    const price = parseFloat(document.getElementById('product-price').value) || 0;
                    const category = document.getElementById('product-category').value;
                    const originalName = document.getElementById('product-original-name').value;
                    
                    // Vérifier que les champs requis sont remplis
                    if (!name || !unit || !supplier || !category) {
                        showNotification('Veuillez remplir tous les champs obligatoires', 3000);
                        return;
                    }
                    
                    console.log("Données du produit:", {name, quantity, unit, alert, supplier, price, category, originalName});
                    
                    // Vérifier que la catégorie existe
                    if (!StockData.categories[category]) {
                        console.log("Création de la catégorie:", category);
                        StockData.categories[category] = [];
                    }
                    
                    const product = {
                        name,
                        quantity,
                        unit,
                        alert,
                        supplier,
                        price,
                        lowStock: quantity <= alert
                    };
                    
                    // Si on modifie un produit existant
                    if (originalName && originalName !== name) {
                        // Supprimer l'ancien produit
                        const categoryProducts = StockData.categories[category];
                        if (categoryProducts) {
                            const index = categoryProducts.findIndex(p => p.name === originalName);
                            if (index !== -1) {
                                categoryProducts.splice(index, 1);
                            }
                        }
                        
                        // Ajouter une entrée dans l'historique pour le changement de nom
                        StockData.addToHistory({
                            date: new Date(),
                            product: originalName,
                            category: category,
                            action: 'renommage',
                            quantity: 0,
                            unit: '',
                            details: `Renommé en "${name}"`
                        });
                    }
                    
                    // Ajouter ou mettre à jour le produit
                    const result = StockData.addProduct(category, product);
                    
                    if (result) {
                        showNotification(originalName ? 'Produit modifié avec succès!' : 'Produit ajouté avec succès!');
                        
                        // Mettre à jour le compteur d'alertes
                        updateAlertCount();
                        
                        // Mettre à jour les statistiques
                        updateStats();
                        
                        // Revenir à la page des produits
                        showPage('products-page');
                        renderProductsList(category);
                    } else {
                        showNotification('Erreur lors de la sauvegarde du produit. Veuillez réessayer.', 3000);
                    }
                } catch (error) {
                    console.error('Erreur lors de l\'ajout ou de la modification du produit:', error);
                    showNotification('Erreur lors de l\'ajout du produit: ' + error.message, 3000);
                }
            });
            
            // Export des commandes par email
            document.getElementById('export-orders').addEventListener('click', function() {
                const emailTo = document.getElementById('email-to').value;
                const emailSubject = document.getElementById('email-subject').value;
                
                if (!emailTo || !emailSubject) {
                    showNotification('Veuillez remplir tous les champs du formulaire d\'email.', 3000);
                    return;
                }
                
                // Créer le contenu de l'email
                let emailBody = "Liste de commandes - Green Sushi\n\n";
                
                const orders = StockData.getOrdersByCategory();
                for (const category in orders) {
                    emailBody += `== ${category} ==\n`;
                    orders[category].forEach(product => {
                        emailBody += `- ${product.name}: ${product.quantity} ${product.unit} (${product.supplier})\n`;
                    });
                    emailBody += "\n";
                }
                
                // Encoder le corps du message pour mailto
                const encodedBody = encodeURIComponent(emailBody);
                const mailtoLink = `mailto:${emailTo}?subject=${encodeURIComponent(emailSubject)}&body=${encodedBody}`;
                
                // Ouvrir le client email
                window.location.href = mailtoLink;
                
                // Afficher la modale de confirmation
                document.getElementById('confirmation-modal').style.display = 'flex';
                
                // Copier le texte au presse-papier
                try {
                    navigator.clipboard.writeText(emailBody).then(() => {
                        showPopup('Commande copiée dans le presse-papier!');
                    });
                } catch (e) {
                    console.warn('Copie dans le presse-papier non supportée');
                    showNotification('Impossible de copier dans le presse-papier', 3000);
                }
            });
            
            // Fermer la modal de confirmation
            document.getElementById('confirm-modal').addEventListener('click', function() {
                document.getElementById('confirmation-modal').style.display = 'none';
            });
            
            // Gestion des fournisseurs
            document.getElementById('manage-suppliers').addEventListener('click', function() {
                // Afficher la modal
                document.getElementById('suppliers-modal').style.display = 'flex';
                
                // Rendre la liste des fournisseurs
                renderSuppliersList();
            });
            
            document.getElementById('close-suppliers-modal').addEventListener('click', function() {
                // Fermer la modal
                document.getElementById('suppliers-modal').style.display = 'none';
                
                // Mettre à jour le select des fournisseurs
                prepareProductForm();
            });
            
            document.getElementById('add-supplier').addEventListener('click', function() {
                const supplierName = document.getElementById('supplier-name').value;
                if (addSupplier(supplierName)) {
                    // Vider le champ
                    document.getElementById('supplier-name').value = '';
                }
            });
            
            // Permettre l'ajout d'un fournisseur en appuyant sur Entrée
            document.getElementById('supplier-name').addEventListener('keyup', function(e) {
                if (e.key === 'Enter') {
                    const supplierName = this.value;
                    if (addSupplier(supplierName)) {
                        // Vider le champ
                        this.value = '';
                    }
                }
            });
            
            // Gestion des fournisseurs
            document.getElementById('manage-suppliers').addEventListener('click', function() {
                // Afficher la modal
                document.getElementById('suppliers-modal').style.display = 'flex';
                
                // Rendre la liste des fournisseurs
                renderSuppliersList();
            });
            
            document.getElementById('close-suppliers-modal').addEventListener('click', function() {
                // Fermer la modal
                document.getElementById('suppliers-modal').style.display = 'none';
                
                // Mettre à jour le select des fournisseurs
                prepareProductForm();
            });
            
            document.getElementById('add-supplier').addEventListener('click', function() {
                const supplierName = document.getElementById('supplier-name').value;
                if (addSupplier(supplierName)) {
                    // Vider le champ
                    document.getElementById('supplier-name').value = '';
                }
            });
            
            // Permettre l'ajout d'un fournisseur en appuyant sur Entrée
            document.getElementById('supplier-name').addEventListener('keyup', function(e) {
                if (e.key === 'Enter') {
                    const supplierName = this.value;
                    if (addSupplier(supplierName)) {
                        // Vider le champ
                        this.value = '';
                    }
                }
            });
            
            // Bouton de réinitialisation de l'historique
            document.getElementById('reset-history').addEventListener('click', function() {
                // Demander une confirmation
                if (confirm('Êtes-vous sûr de vouloir supprimer tout l\'historique ? Cette action est irréversible.')) {
                    // Réinitialiser l'historique
                    StockData.resetHistory();
                    
                    // Mettre à jour l'affichage
                    renderHistory('week');
                    
                    // Notification
                    showPopup('Historique réinitialisé');
                }
            });
            
            // Initialiser la page d'accueil
            showPage('home-page');
            activateTab('home-page');
        }
        
        // Démarrer l'application au chargement du DOM
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
